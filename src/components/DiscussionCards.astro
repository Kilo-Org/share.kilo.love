---
import type { GitHubDiscussion } from '../types/github';
import { CircleArrowUp } from '@lucide/astro';

export interface Props {
  discussions: GitHubDiscussion[];
}

const { discussions } = Astro.props;

// Utility function to extract first image from discussion body
function extractFirstImage(bodyHTML: string): string | null {
  const imgRegex = /<img[^>]+src="([^">]+)"/i;
  const match = bodyHTML.match(imgRegex);
  return match ? match[1] : null;
}

// Utility function to extract text content from HTML and truncate
function extractTextContent(bodyHTML: string, maxLength: number = 200): string {
  // Remove HTML tags and get plain text
  const textContent = bodyHTML.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
  return textContent.length > maxLength 
    ? textContent.substring(0, maxLength) + '...'
    : textContent;
}

// Utility function to format date
function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric' 
  });
}

function getPlaceholder(seed: string): string {
  return `https://picsum.photos/seed/${seed}/500/500`
}

// Placeholder image URL
const PLACEHOLDER_IMAGE = "https://picsum.photos/seed/picsum/500/500";
---

<div class="mx-auto max-w-7xl px-6 lg:px-8">
  <div class="mx-auto mt-16 grid max-w-2xl grid-cols-1 gap-x-8 gap-y-20 lg:mx-0 lg:max-w-none lg:grid-cols-3">
    {discussions.map((discussion) => {
      const firstImage = extractFirstImage(discussion.bodyHTML);
      const textContent = extractTextContent(discussion.bodyHTML);
      const formattedDate = formatDate(discussion.createdAt);
      const labels = discussion.labels.nodes;
      
      return (
        <article class="flex flex-col items-start justify-between">
          <div class="relative w-full">
            <img
              src={firstImage || getPlaceholder(discussion.id)}
              alt={discussion.title}
              class="aspect-video w-full rounded-2xl bg-gray-100 object-cover sm:aspect-[2/1] lg:aspect-[3/2]"
            />
            <div class="absolute inset-0 rounded-2xl ring-1 ring-inset ring-gray-900/10"></div>
          </div>
          
          <div class="flex max-w-xl grow flex-col justify-between">
            <div class="mt-8 flex items-center gap-x-4 text-xs">
              <time datetime={discussion.createdAt} class="text-gray-500">
                {formattedDate}
              </time>
              {labels.length > 0 && (
                <a
                  href={discussion.url}
                  class="relative z-10 rounded-full bg-gray-50 px-3 py-1.5 font-medium text-gray-600 hover:bg-gray-100"
                  style={`background-color: #${labels[0].color}20; color: #${labels[0].color}`}
                >
                  {labels[0].name}
                </a>
              )}
            </div>
            
            <div class="group relative grow">
              <h3 class="mt-3 text-lg/6 font-semibold text-gray-900 group-hover:text-gray-600">
                <a href={`/projects/${discussion.number}`}>
                  <span class="absolute inset-0"></span>
                  {discussion.title}
                </a>
              </h3>
              <p class="mt-5 line-clamp-3 text-sm/6 text-gray-600">
                {textContent || "No description available."}
              </p>
              <div class="mt-4 flex gap-x-3">
                <a
                  href={`/projects/${discussion.number}`}
                  class="text-sm font-semibold text-indigo-600 hover:text-indigo-500"
                >
                  View Details →
                </a>
                <a
                  href={discussion.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-sm font-semibold text-gray-600 hover:text-gray-500"
                >
                  GitHub →
                </a>
              </div>
            </div>
            
            <div class="relative mt-8 flex items-center gap-x-4 justify-self-end">
              <img
                src={discussion.author.avatarUrl}
                alt={`${discussion.author.login} avatar`}
                class="size-10 rounded-full bg-gray-100"
              />
              <div class="text-sm/6">
                <p class="font-semibold text-gray-900">
                  <a href={discussion.author.url} target="_blank" rel="noopener noreferrer">
                    <span class="absolute inset-0"></span>
                    {discussion.author.login}
                  </a>
                </p>
                <p class="text-gray-600 flex items-center gap-1">
                  {discussion.category.name} •
                  <span class="flex items-center gap-1">
                    <CircleArrowUp class="size-4" />
                    {discussion.upvoteCount || 0} upvotes
                  </span>
                  • {discussion.comments.totalCount} comments
                </p>
              </div>
            </div>
          </div>
        </article>
      );
    })}
  </div>
</div>

{discussions.length === 0 && (
  <div class="mx-auto max-w-7xl px-6 lg:px-8">
    <div class="mx-auto mt-16 text-center">
      <div class="mx-auto flex size-12 items-center justify-center rounded-full bg-gray-100">
        <svg class="size-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" />
        </svg>
      </div>
      <h3 class="mt-2 text-sm font-semibold text-gray-900">No discussions found</h3>
      <p class="mt-1 text-sm text-gray-500">Get started by creating a new discussion on GitHub.</p>
      <div class="mt-6">
        <a
          href="https://github.com/Kilo-Org/kilocode/discussions/categories/built-with-kilo"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
        >
          Start a discussion
        </a>
      </div>
    </div>
  </div>
)}